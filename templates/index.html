<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>⚽ Predicta: Futbol Tahminleri</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: var(--bs-light); transition: background 0.3s, color 0.3s; }
    body.dark-mode { background: #121212; color: #e0e0e0; }
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .container-box { background: white; padding: 25px; margin-top: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
    body.dark-mode .container-box { background: #1e1e1e; }
    .match-card { border-left: 5px solid #3498db; margin-bottom: 15px; padding: 20px; border-radius: 12px; background: #f8f9fa; transition: transform 0.2s; }
    .match-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    body.dark-mode .match-card { background: #2a2a2a; }
    .logic-badge { background: #17a2b8; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; }
    .progress { height: 20px; }
    footer { margin-top: 40px; text-align: center; padding: 15px; color: #777; }
    body.dark-mode footer { color: #aaa; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">⚽ Predicta</a>
    <div class="d-flex">
      <button class="btn btn-outline-light" id="darkModeToggle">🌙 Dark Mode</button>
    </div>
  </div>
</nav>

<div class="container container-box">
  <div class="text-center mb-4">
    <h2>Güncel Futbol Maç Tahminleri</h2>
    <small class="text-muted">Son Güncelleme: {{ current_time.strftime('%d.%m.%Y %H:%M') }}</small>
  </div>

  <!-- Güven Kontrol -->
  <div class="mb-4 p-3 border rounded">
    <div class="row align-items-center">
      <div class="col-md-6">
        <label for="confidenceSlider" class="form-label">
          <strong>Minimum Güven: <span id="confidenceValue">{{ confidence_threshold|round(1) }}%</span></strong>
        </label>
        <input type="range" class="form-range" id="confidenceSlider" 
               min="20" max="95" step="5" value="{{ confidence_threshold|round(1) }}">
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100" onclick="updatePredictions()">🔄 Tahminleri Güncelle</button>
      </div>
      <div class="col-md-3 text-center">
        <small>Toplam Maç: <strong>{{ stats.total_matches }}</strong></small><br>
        <small>Ort. Güven: <strong>{{ "%.1f"|format(stats.average_confidence) }}%</strong></small>
      </div>
    </div>
  </div>

  <!-- Sekmeler -->
  <ul class="nav nav-tabs" id="predictaTabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#matches" type="button">🎯 Maçlar</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#charts" type="button">📊 Grafikler</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#details" type="button">🔍 Detaylar</button></li>
  </ul>

  <div class="tab-content mt-3">
    <!-- Maçlar -->
    <div class="tab-pane fade show active" id="matches">
      {% if predictions %}
        {% for p in predictions %}
        <div class="match-card">
          <div class="row">
            <div class="col-md-8">
              <h5>{{ p.mac }}</h5>
              <p><strong>Lig:</strong> {{ p.lig }} | <strong>Tarih:</strong> {{ p.tarih }}</p>
              <p>
                <strong>MS:</strong> <span class="logic-badge">{{ p.tahmin_ms }}</span>
                <strong>İY:</strong> <span class="logic-badge">{{ p.tahmin_iy }}</span>
                <strong>Skor:</strong> <span class="logic-badge">{{ p.skor }}</span>
              </p>
            </div>
            <div class="col-md-4">
              <div class="progress">
                <div class="progress-bar 
                  {% if p.guven >= 80 %}bg-success
                  {% elif p.guven >= 60 %}bg-warning
                  {% else %}bg-danger{% endif %}" 
                  style="width: {{ p.guven }}%">
                  {{ "%.1f"|format(p.guven) }}%
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-info">🔭 Henüz maç verisi bulunamadı.</div>
      {% endif %}
    </div>

    <!-- Grafikler -->
    <div class="tab-pane fade" id="charts">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-center">Güven Dağılımı</h6>
          <canvas id="confidenceChart"></canvas>
        </div>
        <div class="col-md-6">
          <h6 class="text-center">Skor Olasılıkları (İlk Maç)</h6>
          <canvas id="scoreChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detaylar -->
    <div class="tab-pane fade" id="details">
      <div class="alert alert-info">
        <h5>🔬 Model Bileşenleri</h5>
        <ul>
          <li>Takım İstatistikleri</li>
          <li>Oyuncu Etkisi</li>
          <li>Son Form</li>
          <li>Karşılaşma Geçmişi</li>
          <li>Oran Analizi</li>
          <li>Lig Pozisyonu</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<footer>
  <p>⚽ Predicta - Gelişmiş Futbol Tahmin Sistemi</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Dark mode toggle
  document.getElementById('darkModeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
  });

  // Güven seviyesi slider
  const slider = document.getElementById('confidenceSlider');
  const valueDisplay = document.getElementById('confidenceValue');
  slider.addEventListener('input', function() {
    valueDisplay.textContent = this.value + '%';
  });

  function updatePredictions() {
    const confidence = slider.value;
    const currentUrl = window.location.origin;
    window.location.href = `${currentUrl}/?min_confidence=${confidence}`;
  }

  // Chart.js grafikleri gerçek verilerden doldur
  async function loadCharts() {
    try {
      const response = await fetch("/matches/predictions?min_confidence=40");
      const data = await response.json();

      // Güven dağılımı hesapla
      let high = 0, medium = 0, low = 0;
      data.forEach(d => {
        if (d.prediction.confidence >= 80) high++;
        else if (d.prediction.confidence >= 60) medium++;
        else low++;
      });

      new Chart(document.getElementById('confidenceChart'), {
        type: 'doughnut',
        data: {
          labels: ['Yüksek (80+)', 'Orta (60-79)', 'Düşük (<60)'],
          datasets: [{
            data: [high, medium, low],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
          }]
        }
      });

      // İlk maçın skor olasılıklarını al
      if (data.length > 0 && data[0].prediction.score_prediction) {
        const firstMatch = data[0];
        if (firstMatch.prediction.score_probabilities) {
          const scores = firstMatch.prediction.score_probabilities.map(s => s.score);
          const probs = firstMatch.prediction.score_probabilities.map(s => s.probability);

          new Chart(document.getElementById('scoreChart'), {
            type: 'bar',
            data: {
              labels: scores,
              datasets: [{
                label: 'Olasılık (%)',
                data: probs,
                backgroundColor: '#3498db'
              }]
            }
          });
        }
      }
    } catch (err) {
      console.error("Grafik yüklenirken hata:", err);
    }
  }

  loadCharts();
</script>
</body>
</html>
