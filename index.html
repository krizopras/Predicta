<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Predicta AI - Profesyonel Futbol Tahmin Sistemi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      color:#fff; min-height:100vh;
    }
    .header {text-align:center; padding:40px 20px; background:rgba(255,255,255,0.05);backdrop-filter:blur(10px);}
    .header h1 {font-size:3rem; font-weight:700; background:linear-gradient(45deg,#ffd700,#ff9800);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .tagline {color:#cfd8dc; margin-top:8px;}
    .version-badge {margin-top:10px;display:inline-block;padding:6px 14px;border-radius:20px;background:rgba(255,215,0,0.15);color:#ffd700;font-size:0.85rem;}
    .container {max-width:1400px; margin:30px auto; padding:0 20px; display:grid; grid-template-columns:280px 1fr; gap:25px;}
    .sidebar {background:rgba(255,255,255,0.08);backdrop-filter:blur(12px);border-radius:16px; padding:20px;}
    .sidebar-title {font-size:1.2rem;font-weight:600;color:#ffd700;margin-bottom:15px;}
    .league-list {max-height:calc(100vh - 200px);overflow-y:auto;}
    .league-item {padding:12px 15px;margin-bottom:10px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.04);cursor:pointer;transition:all .3s ease;}
    .league-item:hover {background:rgba(255,215,0,0.15);transform:translateX(4px);}
    .league-item.active {background:linear-gradient(135deg,#ffd70033,#ff980033);border-left:4px solid #ffd700;}
    .league-name {font-size:0.95rem;}
    .league-count {background:rgba(255,215,0,0.25);padding:2px 8px;border-radius:10px;font-size:0.75rem;color:#ffd700;}
    .stats-container {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:25px;}
    .stat-box {background:rgba(255,255,255,0.07);border-radius:14px;padding:20px;text-align:center;}
    .stat-value {font-size:2.2rem;font-weight:700;color:#ffd700;margin-bottom:8px;}
    .stat-label {color:#cfd8dc;font-size:0.9rem;}
    .controls {display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px;}
    .control-label {font-weight:600;color:#ffd700;}
    .filter-btn,.sort-btn {padding:10px 18px;border:none;border-radius:8px;background:rgba(255,255,255,0.08);color:#fff;font-weight:600;cursor:pointer;}
    .filter-btn.active,.sort-btn.active {background:linear-gradient(135deg,#ffd700,#ff9800);color:#1a237e;}
    .main-content {background:rgba(255,255,255,0.05);border-radius:16px;backdrop-filter:blur(10px);padding:20px;}
    .loading {text-align:center;padding:40px;color:#ffd700;}
    .match-list {display:grid;gap:20px;}
    .match-card {background:rgba(255,255,255,0.06);border-radius:16px;padding:20px;border-left:5px solid #ffd700;}
    .match-header {display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;}
    .match-teams {font-size:1.2rem;font-weight:600;}
    .match-league {font-size:0.85rem;color:#b0bec5;}
    .prediction-badge {padding:8px 16px;border-radius:20px;font-size:0.85rem;font-weight:600;color:#fff;}
    .very-high {background:linear-gradient(135deg,#4caf50,#2e7d32);}
    .high {background:linear-gradient(135deg,#2196f3,#1565c0);}
    .medium {background:linear-gradient(135deg,#ff9800,#f57c00);}
    .low {background:linear-gradient(135deg,#f44336,#c62828);}
    .odds-container {display:flex;gap:10px;margin-top:15px;}
    .odds-btn {flex:1;background:rgba(255,255,255,0.08);padding:12px;border-radius:10px;text-align:center;}
    .odds-btn.predicted {border:2px solid #ffd700;}
    .odds-label {font-size:0.8rem;color:#b0bec5;}
    .odds-value {font-size:1.05rem;font-weight:700;}
    
    /* Lig gruplama stilleri */
    .league-section {margin-bottom:30px;}
    .league-header {background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,152,0,0.2));padding:15px 20px;border-radius:12px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;}
    .league-title {font-size:1.3rem;font-weight:700;color:#ffd700;}
    .league-match-count {background:rgba(255,255,255,0.2);padding:5px 12px;border-radius:20px;font-size:0.9rem;}
  </style>
</head>
<body>
<header class="header">
  <h1>Predicta AI</h1>
  <div class="tagline">Profesyonel Futbol Tahmin Platformu</div>
  <div class="version-badge">v7.4 - Doğru Lig Sınıflandırma</div>
</header>

<div class="container">
  <aside class="sidebar">
    <div class="sidebar-title">📋 Ligler</div>
    <div id="league-list" class="league-list">
      <div class="loading">Ligler yükleniyor...</div>
    </div>
  </aside>

  <main>
    <div class="stats-container">
      <div class="stat-box"><div class="stat-value" id="total-matches">0</div><div class="stat-label">Toplam Maç</div></div>
      <div class="stat-box"><div class="stat-value" id="high-confidence">0</div><div class="stat-label">Yüksek Güven</div></div>
      <div class="stat-box"><div class="stat-value" id="medium-confidence">0</div><div class="stat-label">Orta Güven</div></div>
      <div class="stat-box"><div class="stat-value" id="selected-league-name">Tüm Ligler</div><div class="stat-label">Seçili Lig</div></div>
    </div>

    <div class="controls">
      <span class="control-label">Filtrele:</span>
      <button class="filter-btn active" onclick="filterMatches('all',event)">Tümü</button>
      <button class="filter-btn" onclick="filterMatches('high-confidence',event)">Yüksek Güven</button>
      <button class="filter-btn" onclick="filterMatches('medium',event)">Orta Güven</button>
      <span class="control-label" style="margin-left:auto;">Sırala:</span>
      <button class="sort-btn active" onclick="sortMatches('confidence',event)">Güvene Göre</button>
      <button class="sort-btn" onclick="sortMatches('time',event)">Zamana Göre</button>
    </div>

    <div class="main-content">
      <div id="content-area" class="loading">AI tahmin motoru başlatılıyor...</div>
    </div>
  </main>
</div>

<script>
  let allMatches = [];
  let currentFilter = 'all';
  let currentSort = 'confidence';
  let selectedLeague = 'all';
  const API_BASE_URL = 'https://predicta-production.up.railway.app';

  // Gelişmiş lig eşleştirme sistemi - DÜZELTİLMİŞ
  const leagueMapping = {
    // İngiltere
    "Premier League": ["Bournemouth", "Fulham", "Arsenal", "Chelsea", "Liverpool", "Manchester City", "Manchester United", "Tottenham", "Newcastle", "Brighton", "West Ham", "Crystal Palace", "Wolves", "Aston Villa", "Leeds", "Everton", "Southampton", "Nottingham Forest", "Brentford", "Burnley", "Sheffield United", "Luton Town"],
    
    // İtalya
    "Serie A": ["Verona", "Sassuolo", "Juventus", "Inter", "Milan", "Napoli", "Roma", "Lazio", "Atalanta", "Fiorentina", "Torino", "Bologna", "Monza", "Udinese", "Empoli", "Salernitana", "Lecce", "Genoa", "Frosinone", "Cagliari"],
    
    // İspanya
    "La Liga": ["Osasuna", "Getafe", "Real Madrid", "Barcelona", "Atletico Madrid", "Sevilla", "Valencia", "Villarreal", "Real Betis", "Athletic Bilbao", "Real Sociedad", "Celta Vigo", "Mallorca", "Cadiz", "Granada", "Alaves", "Rayo Vallecano", "Las Palmas", "Girona", "Almeria", "Valladolid", "Elche", "Espanyol"],
    
    // Almanya
    "Bundesliga": ["Hoffenheim", "Cologne", "Bayern Munich", "Borussia Dortmund", "RB Leipzig", "Bayer Leverkusen", "Borussia Mönchengladbach", "Eintracht Frankfurt", "Wolfsburg", "Union Berlin", "Freiburg", "Mainz", "Augsburg", "Stuttgart", "Bochum", "Darmstadt", "Heidenheim", "Werder Bremen"],
    
    // Fransa
    "Ligue 1": ["Paris FC", "Lorient", "Paris Saint-Germain", "Marseille", "Lyon", "Monaco", "Lille", "Nice", "Rennes", "Lens", "Reims", "Nantes", "Montpellier", "Toulouse", "Strasbourg", "Auxerre", "Clermont Foot", "Ajaccio", "Troyes", "Angers", "Brest", "Metz", "Le Havre"],
    
    // Hollanda
    "Eredivisie": ["NAC Breda", "Groningen", "Ajax", "PSV", "Feyenoord", "AZ Alkmaar", "Twente", "Utrecht", "Vitesse", "Heerenveen", "Sparta Rotterdam", "Fortuna Sittard", "Heracles", "PEC Zwolle", "Excelsior", "RKC Waalwijk", "Cambuur", "Go Ahead Eagles", "Volendam", "Almere City"],
    
    // Portekiz
    "Primeira Liga": ["Casa Pia", "Estoril", "Benfica", "Porto", "Sporting CP", "Braga", "Vitoria Guimaraes", "Boavista", "Famalicao", "Rio Ave", "Santa Clara", "Vizela", "Arouca", "Chaves", "Portimonense", "Maritimo", "Paços de Ferreira", "Gil Vicente"],
    
    // Türkiye
    "Süper Lig": ["Fenerbahçe", "Galatasaray", "Beşiktaş", "Trabzonspor", "Başakşehir", "Sivasspor", "Alanyaspor", "Kayserispor", "Gençlerbirliği", "Ankaragücü", "Konyaspor", "Kasımpaşa", "Hatayspor", "Giresunspor", "Ümraniyespor", "İstanbulspor", "Gaziantep", "Adana Demirspor", "Antalyaspor", "Fatih Karagümrük", "Pendikspor", "Samsunspor", "Çaykur Rizespor"]
  };

  // API'den gelen lig ID'leri için mapping
  const leagueNames = {
    1300: "Süper Lig",
    681: "Premier League", 
    642: "La Liga",
    994: "Serie A",
    780: "Bundesliga",
    2664: "Ligue 1",
    108: "Eredivisie",
    564: "Primeira Liga",
    1597: "MLS"
  };

  // Lig isimlerini düzeltme fonksiyonu
  function correctLeagueName(leagueName) {
    const corrections = {
      "Italy - Serie A": "Serie A",
      "Spain - La Liga": "La Liga", 
      "Germany - Bundesliga": "Bundesliga",
      "France - Ligue 1": "Ligue 1",
      "Netherlands - Eredivisie": "Eredivisie",
      "Portugal - Primeira Liga": "Primeira Liga",
      "Turkiye - Super Lig": "Süper Lig"
    };
    return corrections[leagueName] || leagueName;
  }

  async function loadMatches() {
    try {
      showLoading();
      const response = await fetch(`${API_BASE_URL}/api/predictions/upcoming?limit=500`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      if (data.success && data.matches) {
        allMatches = data.matches;
        // Lig isimlerini düzelt ve takım isimlerine göre lig ataması yap
        allMatches = allMatches.map(match => {
          // Önce mevcut lig ismini düzelt
          if (match.league_name) {
            match.league_name = correctLeagueName(match.league_name);
          }
          
          // Takım isimlerine göre lig tespiti yap
          const detectedLeague = detectLeagueByTeamNames(match.home_team, match.away_team);
          if (detectedLeague) {
            match.league_name = detectedLeague;
          }
          return match;
        });
        buildLeagueList();
        updateStats();
        applyFiltersAndSort();
      }
    } catch (err) {
      showError(err.message);
    }
  }

  // Takım isimlerine göre lig tespiti
  function detectLeagueByTeamNames(homeTeam, awayTeam) {
    for (const [league, teams] of Object.entries(leagueMapping)) {
      const homeInLeague = teams.some(team => 
        homeTeam.toLowerCase().includes(team.toLowerCase())
      );
      const awayInLeague = teams.some(team => 
        awayTeam.toLowerCase().includes(team.toLowerCase())
      );
      
      if (homeInLeague && awayInLeague) {
        return league;
      } else if (homeInLeague || awayInLeague) {
        // Sadece bir takım bulundu, ama yine de bu lig olabilir
        return league;
      }
    }
    return null;
  }

  function buildLeagueList() {
    const leagueCounts = {};
    allMatches.forEach(m => {
      const lName = m.league_name || leagueNames[m.league] || m.league;
      leagueCounts[lName] = (leagueCounts[lName] || 0) + 1;
    });
    
    const sorted = Object.entries(leagueCounts).sort((a, b) => b[1] - a[1]);
    let html = `<div class="league-item ${selectedLeague === 'all' ? 'active' : ''}" onclick="selectLeague('all', event)">
                    🌍 <span class="league-name">Tüm Ligler</span>
                    <span class="league-count">${allMatches.length}</span></div>`;
    sorted.forEach(([l, c]) => {
      html += `<div class="league-item ${selectedLeague === l ? 'active' : ''}" onclick="selectLeague('${l}', event)">
                  ⚽ <span class="league-name">${l}</span>
                  <span class="league-count">${c}</span></div>`;
    });
    document.getElementById('league-list').innerHTML = html;
  }

  function selectLeague(l, event) {
    selectedLeague = String(l);
    document.querySelectorAll('.league-item').forEach(x => x.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('selected-league-name').textContent = l === 'all' ? 'Tüm Ligler' : l;
    applyFiltersAndSort();
  }

  function filterMatches(f, event) {
    currentFilter = f;
    document.querySelectorAll('.filter-btn').forEach(x => x.classList.remove('active'));
    event.currentTarget.classList.add('active');
    applyFiltersAndSort();
  }

  function sortMatches(s, event) {
    currentSort = s;
    document.querySelectorAll('.sort-btn').forEach(x => x.classList.remove('active'));
    event.currentTarget.classList.add('active');
    applyFiltersAndSort();
  }

  function normalizeConfidence(c) { return c <= 1 ? c * 100 : c; }
  function getConfidenceClass(c) { 
    if (c >= 80) return 'very-high'; 
    if (c >= 65) return 'high'; 
    if (c >= 50) return 'medium'; 
    return 'low'; 
  }

  function applyFiltersAndSort() {
    let filtered = [...allMatches];
    if (selectedLeague !== 'all') filtered = filtered.filter(m => (m.league_name || leagueNames[m.league] || m.league) === selectedLeague);
    if (currentFilter === 'high-confidence') filtered = filtered.filter(m => normalizeConfidence(m.ai_prediction?.confidence || 0) >= 65);
    if (currentFilter === 'medium') filtered = filtered.filter(m => { let c = normalizeConfidence(m.ai_prediction?.confidence || 0); return c >= 50 && c < 65; });
    if (currentSort === 'confidence') filtered.sort((a, b) => normalizeConfidence(b.ai_prediction?.confidence || 0) - normalizeConfidence(a.ai_prediction?.confidence || 0));
    if (currentSort === 'time') filtered.sort((a, b) => (`${a.date} ${a.time}`).localeCompare(`${b.date} ${b.time}`));
    updateStats(filtered); 
    displayMatches(filtered);
  }

  function updateStats(f = allMatches) {
    document.getElementById('total-matches').textContent = f.length;
    document.getElementById('high-confidence').textContent = f.filter(m => normalizeConfidence(m.ai_prediction?.confidence || 0) >= 65).length;
    document.getElementById('medium-confidence').textContent = f.filter(m => { let c = normalizeConfidence(m.ai_prediction?.confidence || 0); return c >= 50 && c < 65; }).length;
  }

  // GELİŞMİŞ LİG GRUPLAMA GÖRÜNÜMÜ
  function displayMatches(matches) {
    const area = document.getElementById('content-area');
    if (matches.length === 0) { 
      area.innerHTML = `<div class="loading">Bu lig/filtre için maç bulunamadı</div>`; 
      return; 
    }

    // Maçları liglerine göre grupla
    const grouped = {};
    matches.forEach(m => {
      const ligAdi = m.league_name || leagueNames[m.league] || m.league || "Diğer Ligler";
      if (!grouped[ligAdi]) grouped[ligAdi] = [];
      grouped[ligAdi].push(m);
    });

    // Ligleri önem sırasına göre sırala
    const priorityLeagues = ["Süper Lig", "Premier League", "La Liga", "Serie A", "Bundesliga", "Ligue 1", "Eredivisie", "Primeira Liga", "MLS"];
    const sortedLeagues = Object.keys(grouped).sort((a, b) => {
      const aIndex = priorityLeagues.indexOf(a);
      const bIndex = priorityLeagues.indexOf(b);
      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
      if (aIndex !== -1) return -1;
      if (bIndex !== -1) return 1;
      return a.localeCompare(b);
    });

    let html = '';
    sortedLeagues.forEach(ligAdi => {
      const maclar = grouped[ligAdi];
      
      html += `<div class="league-section">
                <div class="league-header">
                  <div class="league-title">${ligAdi}</div>
                  <div class="league-match-count">${maclar.length} maç</div>
                </div>
                <div class="match-list">`;
      
      maclar.forEach(m => {
        const p = m.ai_prediction || {};
        const conf = normalizeConfidence(p.confidence || 0);
        const result = p.predicted_result || p.result || 'X';
        
        html += `<div class="match-card">
                   <div class="match-header">
                     <div>
                       <div class="match-teams">${m.home_team} vs ${m.away_team}</div>
                       <div class="match-league">${m.date} ${m.time}</div>
                     </div>
                     <div class="prediction-badge ${getConfidenceClass(conf)}">
                       Tahmin: ${result} (${conf.toFixed(1)}%)
                     </div>
                   </div>
                   <div class="odds-container">
                     <div class="odds-btn ${result === '1' ? 'predicted' : ''}">
                       <div class="odds-label">1</div>
                       <div class="odds-value">${(m.odds?.['1'] || 2.0).toFixed(2)}</div>
                     </div>
                     <div class="odds-btn ${result === 'X' ? 'predicted' : ''}">
                       <div class="odds-label">X</div>
                       <div class="odds-value">${(m.odds?.X || 3.0).toFixed(2)}</div>
                     </div>
                     <div class="odds-btn ${result === '2' ? 'predicted' : ''}">
                       <div class="odds-label">2</div>
                       <div class="odds-value">${(m.odds?.['2'] || 3.5).toFixed(2)}</div>
                     </div>
                   </div>
                 </div>`;
      });
      
      html += `</div></div>`;
    });

    area.innerHTML = html;
  }

  function showLoading() { document.getElementById('content-area').innerHTML = '<div class="loading">Veriler yükleniyor...</div>'; }
  function showError(m) { document.getElementById('content-area').innerHTML = `<div style="color:red">${m}</div>`; }
  
  window.addEventListener('load', () => { 
    loadMatches(); 
    setInterval(loadMatches, 300000); // 5 dakikada bir güncelle
  });
</script>
</body>
</html>